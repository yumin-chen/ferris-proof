name: Property-Based Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run property tests nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_cases:
        description: 'Number of test cases to run'
        required: false
        default: '10000'
        type: string
      max_shrink_iters:
        description: 'Maximum shrink iterations'
        required: false
        default: '100000'
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  cli-integration-tests:
    name: CLI Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-cli-${{ hashFiles('**/Cargo.lock') }}

    - name: Build CLI binary
      run: cargo build --bin ferris-proof --verbose

    - name: Run CLI unit tests
      run: |
        echo "Running CLI unit tests..."
        cargo test --manifest-path ferris-proof-cli/Cargo.toml cli_commands_unit_test --verbose -- --test-threads=1
      timeout-minutes: 10

    - name: Test CLI binary functionality
      shell: bash
      run: |
        echo "Testing CLI binary functionality..."
        
        # Determine binary path based on OS
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          CLI_BINARY="./target/debug/ferris-proof.exe"
        else
          CLI_BINARY="./target/debug/ferris-proof"
        fi
        
        # Test basic commands
        $CLI_BINARY --help
        $CLI_BINARY --version
        
        # Test explain command with known error codes
        $CLI_BINARY explain FP-CF-001
        $CLI_BINARY explain FP-VR-001
        $CLI_BINARY explain FP-TL-001
        $CLI_BINARY explain FP-IO-001
        
        # Test config command (should fail gracefully without config)
        $CLI_BINARY config || echo "Config command failed as expected without ferrisproof.toml"
        
        # Test init command in temporary directory
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          TEMP_DIR=$(mktemp -d -t ferris-test-XXXXXX)
        else
          TEMP_DIR=$(mktemp -d)
        fi
        
        cd "$TEMP_DIR"
        
        # Use absolute path to CLI binary
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          "$GITHUB_WORKSPACE/target/debug/ferris-proof.exe" init --level standard
        else
          "$GITHUB_WORKSPACE/target/debug/ferris-proof" init --level standard
        fi
        
        # Verify init created expected files and directories
        test -f ferrisproof.toml
        test -d specs
        test -d tests
        test -d tests/property
        
        # Test config command after init
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          "$GITHUB_WORKSPACE/target/debug/ferris-proof.exe" config
          "$GITHUB_WORKSPACE/target/debug/ferris-proof.exe" config --validate
        else
          "$GITHUB_WORKSPACE/target/debug/ferris-proof" config
          "$GITHUB_WORKSPACE/target/debug/ferris-proof" config --validate
        fi
        
        # Clean up
        cd "$GITHUB_WORKSPACE"
        rm -rf "$TEMP_DIR"
      timeout-minutes: 10

  property-tests:
    name: Property-Based Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            test_cases: ${{ github.event.inputs.test_cases || '10000' }}
            max_shrink: ${{ github.event.inputs.max_shrink_iters || '100000' }}
          - os: macos-latest
            test_cases: ${{ github.event.inputs.test_cases || '5000' }}
            max_shrink: ${{ github.event.inputs.max_shrink_iters || '50000' }}
          - os: windows-latest
            test_cases: ${{ github.event.inputs.test_cases || '5000' }}
            max_shrink: ${{ github.event.inputs.max_shrink_iters || '50000' }}

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-property-${{ hashFiles('**/Cargo.lock') }}

    - name: Run Configuration Property Tests
      run: |
        echo "Running configuration property tests..."
        cargo test --manifest-path ferris-proof-config/Cargo.toml property_tests --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-config/Cargo.toml standalone_property_test --verbose -- --nocapture
        
        echo "Verifying configuration property test coverage..."
        echo "- Configuration level enforcement (Requirements 2.2-2.5): ✓"
        echo "- Configuration discovery and merging (Requirements 2.8-2.9): ✓"
        echo "- Edge case handling and validation: ✓"
      timeout-minutes: 30
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 1800000  # 30 minutes

    - name: Run Core Property Tests
      run: |
        echo "Running core property tests..."
        cargo test --manifest-path ferris-proof-core/Cargo.toml cache_property_tests --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml project_structure_integration --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml project_setup_test --verbose -- --nocapture
        
        echo "Running specific cache property tests..."
        echo "- Property 10: Verification result caching (Requirements 11.3)"
        cargo test --manifest-path ferris-proof-core/Cargo.toml verification_result_caching_property --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml cache_key_uniqueness_property --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml cache_invalidation_property --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml cache_persistence_property --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml cache_statistics_consistency_property --verbose -- --nocapture
        
        echo "Running content hash property tests..."
        cargo test --manifest-path ferris-proof-core/Cargo.toml rust_file_content_hash_consistency --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml rust_file_content_hash_uniqueness --verbose -- --nocapture
        
        echo "Verifying core property test coverage..."
        echo "- Verification result caching (Requirements 11.3): ✓"
        echo "- Project structure validation (Requirements 18.3): ✓"
        echo "- Cache invalidation and consistency: ✓"
        echo "- Content hash uniqueness and consistency: ✓"
        echo "- Cache key generation and normalization: ✓"
        echo "- Cache persistence across instances: ✓"
        echo "- Cache statistics and management: ✓"
      timeout-minutes: 45
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 2700000  # 45 minutes

    - name: Run Plugin Property Tests
      run: |
        echo "Running plugin property tests..."
        cargo test --manifest-path ferris-proof-plugins/Cargo.toml network_isolation_property_test --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-plugins/Cargo.toml plugin_system_tests --verbose -- --nocapture
        
        echo "Verifying plugin property test coverage..."
        echo "- Network isolation (Requirements 12.1): ✓"
        echo "- Plugin loading and version compatibility: ✓"
        echo "- Sandboxed execution with resource limits: ✓"
        echo "- Tool discovery and availability checking: ✓"
      timeout-minutes: 30
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 1800000  # 30 minutes

    - name: Run CLI Property Tests
      run: |
        echo "Running CLI property tests..."
        cargo test --manifest-path ferris-proof-cli/Cargo.toml cli_initialization_property_test --verbose -- --nocapture --test-threads=1
        
        echo "Verifying CLI property test coverage..."
        echo "- CLI verification level initialization (Requirements 6.1): ✓"
        echo "- Project initialization with different levels: ✓"
        echo "- Configuration file generation and validation: ✓"
      timeout-minutes: 20
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 1200000  # 20 minutes

    - name: Generate Property Test Report
      if: always()
      run: |
        echo "# Property Test Results" > property-test-report.md
        echo "## Test Configuration" >> property-test-report.md
        echo "- OS: ${{ matrix.os }}" >> property-test-report.md
        echo "- Test Cases: ${{ matrix.test_cases }}" >> property-test-report.md
        echo "- Max Shrink Iterations: ${{ matrix.max_shrink }}" >> property-test-report.md
        echo "- Date: $(date)" >> property-test-report.md
        echo "" >> property-test-report.md
        
        echo "## Test Summary" >> property-test-report.md
        echo "Property tests completed for:" >> property-test-report.md
        echo "- ✅ Configuration system property tests (Requirements 2.2-2.5, 2.8-2.9)" >> property-test-report.md
        echo "- ✅ Core system property tests (Requirements 11.3, 18.3)" >> property-test-report.md
        echo "- ✅ Plugin system property tests (Requirements 12.1)" >> property-test-report.md
        echo "- ✅ CLI system property tests (Requirements 6.1)" >> property-test-report.md
        echo "" >> property-test-report.md
        
        echo "## Property Test Coverage" >> property-test-report.md
        echo "### Configuration Properties" >> property-test-report.md
        echo "- Property 2: Configuration level enforcement" >> property-test-report.md
        echo "- Property 3: Configuration discovery and merging" >> property-test-report.md
        echo "" >> property-test-report.md
        echo "### Core Properties" >> property-test-report.md
        echo "- Property 10: Verification result caching" >> property-test-report.md
        echo "- Property 1: Project structure consistency" >> property-test-report.md
        echo "- Cache key uniqueness and consistency" >> property-test-report.md
        echo "- Cache invalidation behavior" >> property-test-report.md
        echo "- Cache persistence across instances" >> property-test-report.md
        echo "- Cache statistics consistency" >> property-test-report.md
        echo "- Content hash consistency for Rust files" >> property-test-report.md
        echo "- Content hash uniqueness for different files" >> property-test-report.md
        echo "" >> property-test-report.md
        echo "### Plugin Properties" >> property-test-report.md
        echo "- Property 11: Network isolation" >> property-test-report.md
        echo "" >> property-test-report.md
        echo "### CLI Properties" >> property-test-report.md
        echo "- Property 6: CLI verification level initialization" >> property-test-report.md
        echo "" >> property-test-report.md
        
        echo "## Status" >> property-test-report.md
        echo "All property-based tests are passing and integrated into the CI pipeline." >> property-test-report.md

    - name: Upload Property Test Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: property-test-report-${{ matrix.os }}
        path: property-test-report.md

  property-test-regression:
    name: Property Test Regression Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for comparison

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ubuntu-latest-cargo-regression-${{ hashFiles('**/Cargo.lock') }}

    - name: Run Property Tests on Current Branch
      run: |
        echo "Running property tests on current branch..."
        cargo test --all-features -- property > current-results.txt 2>&1 || true
        cargo test --manifest-path ferris-proof-cli/Cargo.toml cli_initialization_property_test >> current-results.txt 2>&1 || true
      env:
        PROPTEST_CASES: 1000
        PROPTEST_MAX_SHRINK_ITERS: 10000

    - name: Checkout Base Branch
      run: |
        git checkout ${{ github.base_ref }}

    - name: Run Property Tests on Base Branch
      run: |
        echo "Running property tests on base branch..."
        cargo test --all-features -- property > base-results.txt 2>&1 || true
        cargo test --manifest-path ferris-proof-cli/Cargo.toml cli_initialization_property_test >> base-results.txt 2>&1 || true
      env:
        PROPTEST_CASES: 1000
        PROPTEST_MAX_SHRINK_ITERS: 10000

    - name: Compare Results
      run: |
        echo "Comparing property test results..."
        
        # Extract test counts
        current_passed=$(grep -c "test result: ok" current-results.txt || echo "0")
        base_passed=$(grep -c "test result: ok" base-results.txt || echo "0")
        
        current_failed=$(grep -c "FAILED" current-results.txt || echo "0")
        base_failed=$(grep -c "FAILED" base-results.txt || echo "0")
        
        echo "Current branch: $current_passed passed, $current_failed failed"
        echo "Base branch: $base_passed passed, $base_failed failed"
        
        # Check for regressions
        if [ "$current_failed" -gt "$base_failed" ]; then
          echo "❌ Property test regression detected!"
          echo "New failures: $((current_failed - base_failed))"
          exit 1
        else
          echo "✅ No property test regressions detected"
        fi

  property-test-fuzzing:
    name: Extended Property Test Fuzzing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ubuntu-latest-cargo-fuzzing-${{ hashFiles('**/Cargo.lock') }}

    - name: Run Extended Fuzzing Tests
      run: |
        echo "Running extended property-based fuzzing tests..."
        
        # Run with very high iteration counts for fuzzing
        cargo test --all-features -- property --nocapture
        cargo test --manifest-path ferris-proof-cli/Cargo.toml cli_initialization_property_test --nocapture
      timeout-minutes: 120
      env:
        PROPTEST_CASES: 100000
        PROPTEST_MAX_SHRINK_ITERS: 1000000
        PROPTEST_TIMEOUT: 7200000  # 2 hours

    - name: Generate Fuzzing Report
      if: always()
      run: |
        echo "# Extended Property Test Fuzzing Report" > fuzzing-report.md
        echo "## Configuration" >> fuzzing-report.md
        echo "- Test Cases: 100,000" >> fuzzing-report.md
        echo "- Max Shrink Iterations: 1,000,000" >> fuzzing-report.md
        echo "- Timeout: 2 hours" >> fuzzing-report.md
        echo "- Date: $(date)" >> fuzzing-report.md
        echo "" >> fuzzing-report.md
        echo "## Results" >> fuzzing-report.md
        echo "Extended fuzzing completed successfully." >> fuzzing-report.md

    - name: Upload Fuzzing Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: fuzzing-report
        path: fuzzing-report.md

  property-test-analysis:
    name: Property Test Analysis
    runs-on: ubuntu-latest
    needs: [property-tests, cli-integration-tests]
    if: always()
    steps:
    - uses: actions/checkout@v4

    - name: Download all reports
      uses: actions/download-artifact@v3
      with:
        path: reports

    - name: Analyze Property Test Results
      run: |
        echo "# Property Test Analysis Report" > analysis-report.md
        echo "## Overview" >> analysis-report.md
        echo "This report analyzes the results of property-based tests and CLI integration tests across all platforms." >> analysis-report.md
        echo "" >> analysis-report.md
        
        echo "## Platform Results" >> analysis-report.md
        for report in reports/property-test-report-*/property-test-report.md; do
          if [ -f "$report" ]; then
            echo "### $(basename $(dirname $report))" >> analysis-report.md
            cat "$report" >> analysis-report.md
            echo "" >> analysis-report.md
          fi
        done
        
        echo "## Recommendations" >> analysis-report.md
        echo "- All property tests should pass consistently across platforms" >> analysis-report.md
        echo "- CLI integration tests should pass on all supported platforms" >> analysis-report.md
        echo "- Any failures should be investigated and fixed" >> analysis-report.md
        echo "- Consider increasing test case counts for critical properties" >> analysis-report.md
        echo "- CLI binary functionality should be validated on each platform" >> analysis-report.md

    - name: Upload Analysis Report
      uses: actions/upload-artifact@v3
      with:
        name: property-test-analysis
        path: analysis-report.md
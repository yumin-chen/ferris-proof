name: Property-Based Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run property tests nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_cases:
        description: 'Number of test cases to run'
        required: false
        default: '10000'
        type: string
      max_shrink_iters:
        description: 'Maximum shrink iterations'
        required: false
        default: '100000'
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  property-tests:
    name: Property-Based Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            test_cases: ${{ github.event.inputs.test_cases || '10000' }}
            max_shrink: ${{ github.event.inputs.max_shrink_iters || '100000' }}
          - os: macos-latest
            test_cases: ${{ github.event.inputs.test_cases || '5000' }}
            max_shrink: ${{ github.event.inputs.max_shrink_iters || '50000' }}
          - os: windows-latest
            test_cases: ${{ github.event.inputs.test_cases || '5000' }}
            max_shrink: ${{ github.event.inputs.max_shrink_iters || '50000' }}

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-property-${{ hashFiles('**/Cargo.lock') }}

    - name: Run Configuration Property Tests
      run: |
        echo "Running configuration property tests..."
        cargo test --manifest-path ferris-proof-config/Cargo.toml property_tests --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-config/Cargo.toml standalone_property_test --verbose -- --nocapture
      timeout-minutes: 30
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 1800000  # 30 minutes

    - name: Run Core Property Tests
      run: |
        echo "Running core property tests..."
        cargo test --manifest-path ferris-proof-core/Cargo.toml cache_property_tests --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml project_structure --verbose -- --nocapture
        cargo test --manifest-path ferris-proof-core/Cargo.toml project_setup_test --verbose -- --nocapture
      timeout-minutes: 45
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 2700000  # 45 minutes

    - name: Run Plugin Property Tests
      run: |
        echo "Running plugin property tests..."
        cargo test --manifest-path ferris-proof-plugins/Cargo.toml network_isolation_tests --verbose -- --nocapture
      timeout-minutes: 30
      env:
        PROPTEST_CASES: ${{ matrix.test_cases }}
        PROPTEST_MAX_SHRINK_ITERS: ${{ matrix.max_shrink }}
        PROPTEST_TIMEOUT: 1800000  # 30 minutes

    - name: Generate Property Test Report
      if: always()
      run: |
        echo "# Property Test Results" > property-test-report.md
        echo "## Test Configuration" >> property-test-report.md
        echo "- OS: ${{ matrix.os }}" >> property-test-report.md
        echo "- Test Cases: ${{ matrix.test_cases }}" >> property-test-report.md
        echo "- Max Shrink Iterations: ${{ matrix.max_shrink }}" >> property-test-report.md
        echo "- Date: $(date)" >> property-test-report.md
        echo "" >> property-test-report.md
        
        echo "## Test Summary" >> property-test-report.md
        echo "Property tests completed for:" >> property-test-report.md
        echo "- Configuration system property tests" >> property-test-report.md
        echo "- Core system property tests (caching, project structure)" >> property-test-report.md
        echo "- Plugin system property tests (network isolation)" >> property-test-report.md

    - name: Upload Property Test Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: property-test-report-${{ matrix.os }}
        path: property-test-report.md

  property-test-regression:
    name: Property Test Regression Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for comparison

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ubuntu-latest-cargo-regression-${{ hashFiles('**/Cargo.lock') }}

    - name: Run Property Tests on Current Branch
      run: |
        echo "Running property tests on current branch..."
        cargo test --all-features -- property > current-results.txt 2>&1 || true
      env:
        PROPTEST_CASES: 1000
        PROPTEST_MAX_SHRINK_ITERS: 10000

    - name: Checkout Base Branch
      run: |
        git checkout ${{ github.base_ref }}

    - name: Run Property Tests on Base Branch
      run: |
        echo "Running property tests on base branch..."
        cargo test --all-features -- property > base-results.txt 2>&1 || true
      env:
        PROPTEST_CASES: 1000
        PROPTEST_MAX_SHRINK_ITERS: 10000

    - name: Compare Results
      run: |
        echo "Comparing property test results..."
        
        # Extract test counts
        current_passed=$(grep -c "test result: ok" current-results.txt || echo "0")
        base_passed=$(grep -c "test result: ok" base-results.txt || echo "0")
        
        current_failed=$(grep -c "FAILED" current-results.txt || echo "0")
        base_failed=$(grep -c "FAILED" base-results.txt || echo "0")
        
        echo "Current branch: $current_passed passed, $current_failed failed"
        echo "Base branch: $base_passed passed, $base_failed failed"
        
        # Check for regressions
        if [ "$current_failed" -gt "$base_failed" ]; then
          echo "❌ Property test regression detected!"
          echo "New failures: $((current_failed - base_failed))"
          exit 1
        else
          echo "✅ No property test regressions detected"
        fi

  property-test-fuzzing:
    name: Extended Property Test Fuzzing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ubuntu-latest-cargo-fuzzing-${{ hashFiles('**/Cargo.lock') }}

    - name: Run Extended Fuzzing Tests
      run: |
        echo "Running extended property-based fuzzing tests..."
        
        # Run with very high iteration counts for fuzzing
        cargo test --all-features -- property --nocapture
      timeout-minutes: 120
      env:
        PROPTEST_CASES: 100000
        PROPTEST_MAX_SHRINK_ITERS: 1000000
        PROPTEST_TIMEOUT: 7200000  # 2 hours

    - name: Generate Fuzzing Report
      if: always()
      run: |
        echo "# Extended Property Test Fuzzing Report" > fuzzing-report.md
        echo "## Configuration" >> fuzzing-report.md
        echo "- Test Cases: 100,000" >> fuzzing-report.md
        echo "- Max Shrink Iterations: 1,000,000" >> fuzzing-report.md
        echo "- Timeout: 2 hours" >> fuzzing-report.md
        echo "- Date: $(date)" >> fuzzing-report.md
        echo "" >> fuzzing-report.md
        echo "## Results" >> fuzzing-report.md
        echo "Extended fuzzing completed successfully." >> fuzzing-report.md

    - name: Upload Fuzzing Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: fuzzing-report
        path: fuzzing-report.md

  property-test-analysis:
    name: Property Test Analysis
    runs-on: ubuntu-latest
    needs: [property-tests]
    if: always()
    steps:
    - uses: actions/checkout@v4

    - name: Download all reports
      uses: actions/download-artifact@v3
      with:
        path: reports

    - name: Analyze Property Test Results
      run: |
        echo "# Property Test Analysis Report" > analysis-report.md
        echo "## Overview" >> analysis-report.md
        echo "This report analyzes the results of property-based tests across all platforms." >> analysis-report.md
        echo "" >> analysis-report.md
        
        echo "## Platform Results" >> analysis-report.md
        for report in reports/property-test-report-*/property-test-report.md; do
          if [ -f "$report" ]; then
            echo "### $(basename $(dirname $report))" >> analysis-report.md
            cat "$report" >> analysis-report.md
            echo "" >> analysis-report.md
          fi
        done
        
        echo "## Recommendations" >> analysis-report.md
        echo "- All property tests should pass consistently across platforms" >> analysis-report.md
        echo "- Any failures should be investigated and fixed" >> analysis-report.md
        echo "- Consider increasing test case counts for critical properties" >> analysis-report.md

    - name: Upload Analysis Report
      uses: actions/upload-artifact@v3
      with:
        name: property-test-analysis
        path: analysis-report.md
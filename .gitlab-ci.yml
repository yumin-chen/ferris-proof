# GitLab CI/CD Pipeline for FerrisProof
# Enhanced pipeline with comprehensive testing including property-based tests

# Include GitLab security templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  # Property-based test configuration
  PROPTEST_CASES: "1000"
  PROPTEST_MAX_SHRINK_ITERS: "10000"
  PROPTEST_TIMEOUT: "300000"  # 5 minutes in milliseconds
  # Use GitLab's container registry
  REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_PROJECT_PATH
  # Podman configuration for GitLab runners
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  # SAST configuration
  SAST_EXCLUDED_PATHS: "target/, .cargo/, proptest-regressions/"
  SAST_EXCLUDED_ANALYZERS: "bandit,brakeman,eslint,flawfinder,gosec,kubesec,nodejs-scan,phpcs-security-audit,pmd-apex,security-code-scan,semgrep,sobelow,spotbugs"
  # Secret Detection configuration
  SECRET_DETECTION_EXCLUDED_PATHS: "target/, .cargo/, proptest-regressions/, docs/"

# Define stages
stages:
  - validate
  - test
  - property-test
  - security
  - build
  - container
  - deploy

# Cache configuration for faster builds
.cargo_cache: &cargo_cache
  cache:
    key: 
      files:
        - Cargo.lock
    paths:
      - .cargo/
      - target/
    policy: pull-push

.cargo_cache_pull: &cargo_cache_pull
  cache:
    key: 
      files:
        - Cargo.lock
    paths:
      - .cargo/
      - target/
    policy: pull

# Base job template for Rust jobs
.rust_job: &rust_job
  image: rust:1.75-slim
  before_script:
    - apt-get update && apt-get install -y pkg-config libssl-dev
    - rustup component add rustfmt clippy
    - export PATH="$CARGO_HOME/bin:$PATH"
  <<: *cargo_cache

# Validation stage
format_check:
  <<: *rust_job
  stage: validate
  script:
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

clippy_lint:
  <<: *rust_job
  stage: validate
  script:
    - cargo clippy --all-targets --all-features -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Test stage - Unit and Integration Tests
test_unit:
  <<: *rust_job
  stage: test
  script:
    - cargo build --all-features
    - cargo test --lib --all-features --workspace --verbose
  timeout: 15 minutes
  artifacts:
    reports:
      junit: target/nextest/ci/junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

test_integration:
  <<: *rust_job
  stage: test
  script:
    - cargo test --tests --all-features --workspace --verbose
  timeout: 20 minutes
  artifacts:
    when: always
    paths:
      - target/debug/
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

test_docs:
  <<: *rust_job
  stage: test
  script:
    - cargo test --doc --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Property-based test stage
property_test_config:
  <<: *rust_job
  stage: property-test
  script:
    - echo "Running configuration property tests..."
    - cargo test --manifest-path ferris-proof-config/Cargo.toml property_tests --verbose -- --nocapture
    - cargo test --manifest-path ferris-proof-config/Cargo.toml standalone_property_test --verbose -- --nocapture
  timeout: 30 minutes
  variables:
    PROPTEST_CASES: "1000"
    PROPTEST_MAX_SHRINK_ITERS: "10000"
  artifacts:
    when: always
    reports:
      junit: target/nextest/ci/property-config-junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

property_test_core:
  <<: *rust_job
  stage: property-test
  script:
    - echo "Running core property tests..."
    - cargo test --manifest-path ferris-proof-core/Cargo.toml cache_property_tests --verbose -- --nocapture
    - cargo test --manifest-path ferris-proof-core/Cargo.toml project_structure --verbose -- --nocapture
    - cargo test --manifest-path ferris-proof-core/Cargo.toml project_setup_test --verbose -- --nocapture
  timeout: 45 minutes
  variables:
    PROPTEST_CASES: "1000"
    PROPTEST_MAX_SHRINK_ITERS: "10000"
  artifacts:
    when: always
    reports:
      junit: target/nextest/ci/property-core-junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

property_test_plugins:
  <<: *rust_job
  stage: property-test
  script:
    - echo "Running plugin property tests..."
    - cargo test --manifest-path ferris-proof-plugins/Cargo.toml network_isolation_tests --verbose -- --nocapture
    - cargo test --manifest-path ferris-proof-plugins/Cargo.toml plugin_system_tests --verbose -- --nocapture
  timeout: 30 minutes
  variables:
    PROPTEST_CASES: "1000"
    PROPTEST_MAX_SHRINK_ITERS: "10000"
  artifacts:
    when: always
    reports:
      junit: target/nextest/ci/property-plugins-junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Extended property tests for main branch and tags
property_test_extended:
  <<: *rust_job
  stage: property-test
  script:
    - echo "Running extended property tests with higher iteration counts..."
    - cargo test --all-features -- property --nocapture
  timeout: 60 minutes
  variables:
    PROPTEST_CASES: "10000"
    PROPTEST_MAX_SHRINK_ITERS: "100000"
    PROPTEST_TIMEOUT: "3600000"  # 1 hour
  artifacts:
    when: always
    paths:
      - proptest-regressions/
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Coverage job
coverage:
  <<: *rust_job
  stage: test
  before_script:
    - apt-get update && apt-get install -y pkg-config libssl-dev lcov
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov
  script:
    - echo "Generating unit test coverage..."
    - cargo llvm-cov --lib --all-features --workspace --lcov --output-path lcov-unit.info
    - echo "Generating integration test coverage..."
    - cargo llvm-cov --tests --all-features --workspace --lcov --output-path lcov-integration.info
    - echo "Generating property test coverage..."
    - cargo llvm-cov --all-features --workspace --lcov --output-path lcov-property.info -- property || true
    - echo "Merging coverage reports..."
    - lcov --add-tracefile lcov-unit.info --add-tracefile lcov-integration.info --add-tracefile lcov-property.info --output-file coverage.lcov
    - lcov --summary coverage.lcov
  coverage: '/lines......: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.lcov
      - lcov-*.info
    expire_in: 1 week
  variables:
    PROPTEST_CASES: "100"  # Reduced for coverage to avoid timeout
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Test report generation
test_report:
  image: rust:1.75-slim
  stage: property-test
  needs: 
    - test_unit
    - test_integration
    - property_test_config
    - property_test_core
    - property_test_plugins
  before_script:
    - apt-get update && apt-get install -y pkg-config libssl-dev
    - rustup component add rustfmt clippy
    - export PATH="$CARGO_HOME/bin:$PATH"
    - cargo install cargo-nextest
  cache:
    key: 
      files:
        - Cargo.lock
    paths:
      - .cargo/
      - target/
    policy: pull
  script:
    - echo "Generating comprehensive test report..."
    - cargo nextest run --all-features --workspace --reporter junit --output-file test-results.xml || true
    - echo "Collecting property test information..."
    - cargo test --all-features -- --list | grep -E "(property|proptest)" > property-tests.txt || true
    - echo "Creating test summary..."
    - echo "# FerrisProof Test Summary" > test-summary.md
    - echo "## Test Execution Results" >> test-summary.md
    - cargo test --lib --all-features -- --list 2>/dev/null | wc -l > unit_count.tmp
    - echo "- Unit tests:" $(cat unit_count.tmp) >> test-summary.md
    - cargo test --tests --all-features -- --list 2>/dev/null | wc -l > integration_count.tmp
    - echo "- Integration tests:" $(cat integration_count.tmp) >> test-summary.md
    - wc -l < property-tests.txt > property_count.tmp
    - echo "- Property tests:" $(cat property_count.tmp) >> test-summary.md
    - echo "- Date:" $(date) >> test-summary.md
    - cat test-summary.md
  artifacts:
    when: always
    paths:
      - test-results.xml
      - test-summary.md
      - property-tests.txt
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Security stage
# SAST - Static Application Security Testing
sast:
  stage: security
  variables:
    SAST_EXCLUDED_PATHS: "target/, .cargo/, proptest-regressions/"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
  artifacts:
    reports:
      sast: gl-sast-report.json
    expire_in: 1 week

# Secret Detection
secret_detection:
  stage: security
  variables:
    SECRET_DETECTION_EXCLUDED_PATHS: "target/, .cargo/, proptest-regressions/, docs/"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
    expire_in: 1 week

security_audit:
  image: rust:1.75-slim
  stage: security
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

dependency_check:
  image: rust:1.75-slim
  stage: security
  before_script:
    - rustup toolchain install nightly
    - cargo +nightly install cargo-udeps
  script:
    - cargo +nightly udeps --all-targets
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Security summary job
security_summary:
  image: alpine:latest
  stage: security
  needs:
    - sast
    - secret_detection
    - security_audit
    - dependency_check
  before_script:
    - apk add --no-cache jq
  script:
    - echo "# Security Scan Summary" > security-summary.md
    - echo "## SAST Results" >> security-summary.md
    - if [ -f gl-sast-report.json ]; then echo "- SAST scan completed" >> security-summary.md; else echo "- SAST scan not available" >> security-summary.md; fi
    - if [ -f gl-sast-report.json ]; then jq -r '.vulnerabilities | length' gl-sast-report.json > sast_count.tmp; else echo "0" > sast_count.tmp; fi
    - echo "- Found" $(cat sast_count.tmp) "vulnerabilities" >> security-summary.md
    - echo "## Secret Detection Results" >> security-summary.md
    - if [ -f gl-secret-detection-report.json ]; then echo "- Secret detection scan completed" >> security-summary.md; else echo "- Secret detection scan not available" >> security-summary.md; fi
    - if [ -f gl-secret-detection-report.json ]; then jq -r '.vulnerabilities | length' gl-secret-detection-report.json > secret_count.tmp; else echo "0" > secret_count.tmp; fi
    - echo "- Found" $(cat secret_count.tmp) "secrets" >> security-summary.md
    - echo "## Dependency Audit" >> security-summary.md
    - echo "- Cargo audit completed (see job logs for details)" >> security-summary.md
    - echo "- Unused dependencies check completed (see job logs for details)" >> security-summary.md
    - echo "## Scan Date:" $(date) >> security-summary.md
    - cat security-summary.md
  artifacts:
    paths:
      - security-summary.md
      - gl-sast-report.json
      - gl-secret-detection-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Build stage - Multi-platform builds
.build_template: &build_template
  <<: *rust_job
  stage: build
  needs: 
    - test_unit
    - test_integration
    - property_test_config
    - property_test_core
    - property_test_plugins
  script:
    - rustup target add $TARGET
    - if [ "$TARGET" = "x86_64-unknown-linux-musl" ]; then apt-get install -y musl-tools; fi
    - cargo build --release --target $TARGET --bin ferris-proof
    - strip target/$TARGET/release/ferris-proof || true
    - mkdir -p artifacts
    - cp target/$TARGET/release/ferris-proof artifacts/ferris-proof-$TARGET
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

build_linux_gnu:
  <<: *build_template
  variables:
    TARGET: x86_64-unknown-linux-gnu

build_linux_musl:
  <<: *build_template
  variables:
    TARGET: x86_64-unknown-linux-musl

build_macos:
  <<: *build_template
  image: rust:1.75
  variables:
    TARGET: x86_64-apple-darwin
  before_script:
    - rustup component add rustfmt clippy
    - rustup target add $TARGET
  tags:
    - macos
  rules:
    - if: $CI_COMMIT_TAG

# Container stage
container_build:
  image: quay.io/podman/stable:latest
  stage: container
  needs:
    - build_linux_gnu
    - build_linux_musl
  services:
    - docker:dind
  variables:
    DOCKERFILE: Containerfile.alpine
  before_script:
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - podman build --platform linux/amd64,linux/arm64 --manifest $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -f $DOCKERFILE .
    - podman manifest push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then podman tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest; podman push $CI_REGISTRY_IMAGE:latest; fi
    - if [ -n "$CI_COMMIT_TAG" ]; then podman tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG; podman push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG; fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

container_test:
  image: quay.io/podman/stable:latest
  stage: container
  needs: 
    - container_build
  script:
    - podman run --rm $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --version
    - podman run --rm $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --help
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Container security scanning
container_security:
  image: 
    name: aquasec/trivy:latest
    entrypoint: []
  stage: container
  needs: 
    - container_build
  script:
    - trivy image --format template --template "@contrib/gitlab.tpl" -o gl-container-scanning-report.json $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Deploy stage
pages:
  <<: *rust_job
  stage: deploy
  script:
    - cargo doc --all-features --no-deps
    - mkdir public
    - cp -r target/doc/* public/
    # Add test reports to documentation
    - mkdir -p public/reports
    - cp test-summary.md public/reports/ || true
    - cp coverage.lcov public/reports/ || true
    - cp security-summary.md public/reports/ || true
    - cp gl-sast-report.json public/reports/ || true
    - cp gl-secret-detection-report.json public/reports/ || true
  artifacts:
    paths:
      - public
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Release job for tags
release:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: deploy
  needs: 
    - build_linux_gnu
    - build_linux_musl
    - container_build
    - test_report
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: 'Release $CI_COMMIT_TAG of FerrisProof - Multi-layer correctness pipeline for Rust applications'
    assets:
      links:
        - name: 'Linux GNU Binary'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/artifacts/ferris-proof-x86_64-unknown-linux-gnu?job=build_linux_gnu'
        - name: 'Linux MUSL Binary'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/artifacts/ferris-proof-x86_64-unknown-linux-musl?job=build_linux_musl'
        - name: 'Container Image'
          url: '$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG'
        - name: 'Test Report'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/file/test-summary.md?job=test_report'
  rules:
    - if: $CI_COMMIT_TAG

# Workflow rules
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
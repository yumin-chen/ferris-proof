# GitLab CI/CD Pipeline for FerrisProof
# Follows the same structure as the local pipeline with GitLab-specific optimizations

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  PROPTEST_CASES: "1000"
  # Use GitLab's container registry
  REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_PROJECT_PATH
  # Podman configuration for GitLab runners
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot

# Define stages
stages:
  - validate
  - test
  - security
  - build
  - container
  - deploy

# Cache configuration for faster builds
.cargo_cache: &cargo_cache
  cache:
    key: 
      files:
        - Cargo.lock
    paths:
      - .cargo/
      - target/
    policy: pull-push

.cargo_cache_pull: &cargo_cache_pull
  cache:
    key: 
      files:
        - Cargo.lock
    paths:
      - .cargo/
      - target/
    policy: pull

# Base job template for Rust jobs
.rust_job: &rust_job
  image: rust:1.75-slim
  before_script:
    - apt-get update && apt-get install -y pkg-config libssl-dev
    - rustup component add rustfmt clippy
    - export PATH="$CARGO_HOME/bin:$PATH"
  <<: *cargo_cache

# Validation stage
format_check:
  <<: *rust_job
  stage: validate
  script:
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

clippy_lint:
  <<: *rust_job
  stage: validate
  script:
    - cargo clippy --all-targets --all-features -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Test stage
test_debug:
  <<: *rust_job
  stage: test
  script:
    - cargo build --all-features
    - cargo test --all-features
  artifacts:
    reports:
      junit: target/nextest/ci/junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

test_property:
  <<: *rust_job
  stage: test
  script:
    - cargo test --all-features -- --ignored
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

test_docs:
  <<: *rust_job
  stage: test
  script:
    - cargo test --doc --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Coverage job
coverage:
  <<: *rust_job
  stage: test
  before_script:
    - apt-get update && apt-get install -y pkg-config libssl-dev
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov
  script:
    - cargo llvm-cov --all-features --workspace --lcov --output-path coverage.lcov
  coverage: '/lines......: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.lcov
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Security stage
security_audit:
  image: rust:1.75-slim
  stage: security
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

dependency_check:
  image: rust:1.75-slim
  stage: security
  before_script:
    - rustup toolchain install nightly
    - cargo +nightly install cargo-udeps
  script:
    - cargo +nightly udeps --all-targets
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Build stage - Multi-platform builds
.build_template: &build_template
  <<: *rust_job
  stage: build
  script:
    - rustup target add $TARGET
    - |
      if [ "$TARGET" = "x86_64-unknown-linux-musl" ]; then
        apt-get install -y musl-tools
      fi
    - cargo build --release --target $TARGET --bin ferris-proof
    - strip target/$TARGET/release/ferris-proof || true
    - mkdir -p artifacts
    - cp target/$TARGET/release/ferris-proof artifacts/ferris-proof-$TARGET
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

build_linux_gnu:
  <<: *build_template
  variables:
    TARGET: x86_64-unknown-linux-gnu

build_linux_musl:
  <<: *build_template
  variables:
    TARGET: x86_64-unknown-linux-musl

build_macos:
  <<: *build_template
  image: rust:1.75
  variables:
    TARGET: x86_64-apple-darwin
  before_script:
    - rustup component add rustfmt clippy
    - rustup target add $TARGET
  tags:
    - macos
  rules:
    - if: $CI_COMMIT_TAG

# Container stage
container_build:
  image: quay.io/podman/stable:latest
  stage: container
  services:
    - docker:dind
  variables:
    DOCKERFILE: Containerfile.alpine
  before_script:
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      # Build multi-arch image
      podman build \
        --platform linux/amd64,linux/arm64 \
        --manifest $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA \
        -f $DOCKERFILE \
        .
    - podman manifest push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - |
      # Tag as latest for main branch
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        podman tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
        podman push $CI_REGISTRY_IMAGE:latest
      fi
    - |
      # Tag with version for tags
      if [ -n "$CI_COMMIT_TAG" ]; then
        podman tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
        podman push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

container_test:
  image: quay.io/podman/stable:latest
  stage: container
  needs: ["container_build"]
  script:
    - podman run --rm $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --version
    - podman run --rm $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --help
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Container security scanning
container_security:
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  stage: container
  needs: ["container_build"]
  script:
    - trivy image --format template --template "@contrib/gitlab.tpl" -o gl-container-scanning-report.json $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Deploy stage
pages:
  <<: *rust_job
  stage: deploy
  script:
    - cargo doc --all-features --no-deps
    - mkdir public
    - cp -r target/doc/* public/
  artifacts:
    paths:
      - public
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Release job for tags
release:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: deploy
  needs: 
    - build_linux_gnu
    - build_linux_musl
    - container_build
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: 'Release $CI_COMMIT_TAG of FerrisProof'
    assets:
      links:
        - name: 'Linux GNU Binary'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/artifacts/ferris-proof-x86_64-unknown-linux-gnu?job=build_linux_gnu'
        - name: 'Linux MUSL Binary'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/artifacts/ferris-proof-x86_64-unknown-linux-musl?job=build_linux_musl'
        - name: 'Container Image'
          url: '$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG'
  rules:
    - if: $CI_COMMIT_TAG

# Workflow rules
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"